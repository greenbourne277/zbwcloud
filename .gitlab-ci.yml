variables:
  VAULT_OPENJDK_IMAGE: "swr.eu-nl.otc.t-systems.com/zbw-tools-nl/vault-openjdk:latest"

default:
  image: openjdk:17.0.1-slim

stages:
  - build
  - test
  - push

before_script:
  - export GRADLE_USER_HOME=`pwd`/.gradle

build:
  stage: build
  script:
    - ./gradlew assemble --parallel
  artifacts:
    paths:
      - build/libs/*.jar
    expire_in: 1 week

test:
  stage: test
  dependencies:
    - build
  script:
    - ./gradlew check --parallel
  artifacts:
    when: always
    reports:
      junit: app/*/**/TEST-*.xml

pushLoriImage:
  stage: push
  image: $VAULT_OPENJDK_IMAGE
  variables:
    VAULT_ROLE_ID: ci-zbw-dev
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - app/lori/**/*
  dependencies:
    - test
  script:
    - export VAULT_ADDR=https://vault-nl.zbw.eu
    - export VAULT_TOKEN="$(vault write -field=token auth/jwt-cloud/login role=$VAULT_ROLE_ID jwt=$CI_JOB_JWT)"
    - mkdir -p ~/.docker
    - vault kv get -field=config secret/otc-credentials/docker  | base64 -d >> ~/.docker/config.json
    - ./gradlew :app:lori:server:jib
    - rm -rf ~/.docker/config.json

pushLoriImportJob:
  stage: push
  image: $VAULT_OPENJDK_IMAGE
  variables:
    VAULT_ROLE_ID: ci-zbw-dev
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - job/lori_import/**/*
  dependencies:
    - test
  script:
    - export VAULT_ADDR=https://vault-nl.zbw.eu
    - export VAULT_TOKEN="$(vault write -field=token auth/jwt-cloud/login role=$VAULT_ROLE_ID jwt=$CI_JOB_JWT)"
    - mkdir -p ~/.docker
    - vault kv get -field=config secret/otc-credentials/docker  | base64 -d >> ~/.docker/config.json
    - ./gradlew :job:lori_import:jib
    - rm -rf ~/.docker/config.json

pushTemplateApplyJob:
  stage: push
  image: $VAULT_OPENJDK_IMAGE
  variables:
    VAULT_ROLE_ID: ci-zbw-dev
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - job/template_apply/**/*
  dependencies:
    - test
  script:
    - export VAULT_ADDR=https://vault-nl.zbw.eu
    - export VAULT_TOKEN="$(vault write -field=token auth/jwt-cloud/login role=$VAULT_ROLE_ID jwt=$CI_JOB_JWT)"
    - mkdir -p ~/.docker
    - vault kv get -field=config secret/otc-credentials/docker  | base64 -d >> ~/.docker/config.json
    - ./gradlew :job:template_apply:jib
    - rm -rf ~/.docker/config.json

after_script:
  - echo "End CI"
